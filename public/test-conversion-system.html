<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RotaFinal - Teste de Conversão</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: #0f172a; color: #e2e8f0; }
    .container { max-width: 960px; margin: 0 auto; padding: 32px; }
    .card { background: #0b1220; border: 1px solid #1e293b; border-radius: 12px; padding: 24px; }
    .row { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 16px; }
    .btn { background: #2563eb; color: white; border: 0; border-radius: 8px; padding: 10px 14px; cursor: pointer; font-weight: 600; }
    .btn:disabled { background: #334155; cursor: not-allowed; }
    .muted { color: #94a3b8; font-size: 14px; }
    .field { display: grid; gap: 8px; margin-bottom: 12px; }
    input, select { background: #0b1220; color: #e2e8f0; border: 1px solid #1e293b; border-radius: 8px; padding: 10px 12px; }
    pre { background: #0b1220; color: #e2e8f0; border: 1px solid #1e293b; border-radius: 8px; padding: 12px; overflow: auto; }
    .ok { color: #22c55e; }
    .err { color: #ef4444; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Teste Conversões - RotaFinal</h1>
    <p class="muted">Use esta página para validar assignment, page_view e conversion no seu projeto Supabase.</p>

    <div class="card" style="margin-top:16px">
      <div class="row">
        <div>
          <div class="field">
            <label>Supabase URL</label>
            <input id="url" placeholder="https://xxxx.supabase.co" />
          </div>
          <div class="field">
            <label>Anon Key</label>
            <input id="key" placeholder="eyJhbGciOiJI..." />
          </div>
          <div class="field">
            <label>Experiment Key</label>
            <input id="exp" placeholder="meu-experimento" />
          </div>
          <div class="field">
            <label>Visitor ID</label>
            <input id="vid" placeholder="visitor_123" />
          </div>
        </div>
        <div>
          <div class="field">
            <label>Conversion URL (esperada)</label>
            <input id="curl" placeholder="https://seusite.com/obrigado" />
          </div>
          <div class="field">
            <label>Conversion Value (R$)</label>
            <input id="cval" type="number" step="0.01" placeholder="29.90" />
          </div>
          <div class="field">
            <label>Evento</label>
            <select id="etype">
              <option value="page_view">page_view</option>
              <option value="conversion">conversion</option>
            </select>
          </div>
          <div style="display:flex; gap:8px; margin-top:8px">
            <button class="btn" id="assign">1) Assign Variant</button>
            <button class="btn" id="track" disabled>2) Track Event</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3>Logs</h3>
      <pre id="logs">Aguardando...</pre>
    </div>
  </div>

  <script>
    const logEl = document.getElementById('logs');
    function log(msg, type){
      const line = `[${new Date().toLocaleTimeString()}] ${msg}\n`;
      logEl.textContent += line;
      logEl.scrollTop = logEl.scrollHeight;
    }

    const qs = new URLSearchParams(location.search);
    url.value = qs.get('url') || '';
    key.value = qs.get('key') || '';
    exp.value = qs.get('exp') || '';
    vid.value = qs.get('vid') || `visitor_${Math.random().toString(36).slice(2,8)}`;
    curl.value = qs.get('curl') || '';
    cval.value = qs.get('cval') || '';

    assign.onclick = async () => {
      try {
        if(!url.value || !key.value || !exp.value){
          return alert('Preencha URL, Key e Experiment Key');
        }
        const res = await fetch(`${url.value}/functions/v1/assign-variant`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key.value}` },
          body: JSON.stringify({
            experiment_key: exp.value,
            visitor_id: vid.value,
            context: { page_url: location.href, user_agent: navigator.userAgent }
          })
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error || 'Falha no assignment');
        log(`OK assignment → variante: ${data.variant_name} | conv_url: ${data.experiment?.conversion_url}`, 'ok');
        if(!curl.value && data.experiment?.conversion_url){ curl.value = data.experiment.conversion_url; }
        if(!cval.value && data.experiment?.conversion_value){ cval.value = data.experiment.conversion_value; }
        track.disabled = false;
      } catch(e){
        log(`ERRO assignment → ${e.message}`, 'err');
      }
    };

    track.onclick = async () => {
      try {
        const evt = etype.value;
        const payload = {
          events: [{
            visitor_id: vid.value,
            event_type: evt,
            event_name: evt === 'conversion' ? 'purchase' : 'page_view',
            properties: evt === 'conversion' ? { success_page_url: curl.value } : { page_url: location.href },
            value: evt === 'conversion' && cval.value ? Number(cval.value) : undefined,
            experiment_key: exp.value
          }].filter(Boolean)
        };
        const res = await fetch(`${url.value}/functions/v1/track-event`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key.value}` },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error || 'Falha no track');
        log(`OK track → ${evt} enviado com sucesso`);
      } catch(e){
        log(`ERRO track → ${e.message}`, 'err');
      }
    };
  </script>
</body>
</html>
