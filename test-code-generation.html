<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Gera√ß√£o de C√≥digo</title>
</head>
<body>
    <h1>Teste de Gera√ß√£o de C√≥digo</h1>
    <div id="test-results"></div>

    <script>
        // Simular props do OptimizedCodeGenerator
        const experimentId = 'a16734f4-711f-4e3a-bf08-09245289c692';
        const baseUrl = 'https://rotafinal.com.br';
        const apiKey = 'pk_ea145f98f99dc7df53fd4faeedba160f';
        const sdkVersion = '3.0.1-auto-conversion';
        const debugMode = true;
        const antiFlickerTimeout = 120;
        const experimentUrls = ['/elementor-595/'];
        const conversionValue = 0;
        const applyChangesCode = '';
        const conversionTrackingCode = '';
        const setupConversionCode = '';

        // Gerar o c√≥digo como o componente faz
        const inlineSDK = '!function(){"use strict";var e="' + experimentId + '",t="' + baseUrl + '",r="' + apiKey + '",n="' + sdkVersion + '",o=' + (debugMode ? 'true' : 'false') + ',a=' + antiFlickerTimeout + ',i="rf_variant_"+e,s="rf_experiment_"+e,l="rotafinal_exp_"+e,c="rf_queue_"+e,u=18e5,d="rf_redirected_"+e,f="rf_conversion_tracked_"+e,p=' + JSON.stringify(experimentUrls) + ',g=function(e,t){if(o||localStorage.getItem("rf_debug")){try{console.log("[RotaFinal v"+n+"]",e,t||"")}catch(_){}}},h=function(){try{var e="__t";localStorage.setItem(e,"1");localStorage.removeItem(e);return true}catch(_){return false}},m=function(e){try{return localStorage.getItem(e)}catch(_){return null}},v=function(e,t){try{localStorage.setItem(e,t)}catch(_){}},w=function(){if(!p||p.length===0)return true;var e=window.location.pathname;for(var t=0;t<p.length;t++){var r=p[t];if(e===r||e.startsWith(r)||e.includes(r))return true}return false},x=function(){if(!h())return null;try{var e=m(i);if(!e)return null;var t=JSON.parse(e);if(Date.now()-t.t>u)return null;return t.v||null}catch(_){return null}},y=function(){if(!h())return null;try{var e=m(s);if(!e)return null;var t=JSON.parse(e);if(Date.now()-t.t>u)return null;return t.e||null}catch(_){return null}},z=function(e){if(!h())return;v(s,JSON.stringify({e:e,t:Date.now()}))},A=function(e,t){if(!h())return;var r={experimentId:e,experiment_id:e,variantId:t.id,variant_id:t.id,variantName:t.name,variant:t.name,visitorId:B(),visitor_id:B(),timestamp:Date.now()};v(l,JSON.stringify(r));g("üíæ Assignment data saved",r);var n={url:window.location.href,title:document.title,timestamp:Date.now()};v("rotafinal_origin_"+e,JSON.stringify(n));g("üíæ Origin page data saved",n)},C=function(e){if(!e)return false;var t=window.location.href.split("?")[0].split("#")[0],r=e.split("?")[0].split("#")[0];if(r===t)return false;g("‚ö° REDIRECT",e);try{sessionStorage.setItem(d,"1")}catch(_){}window.location.replace(e);return true},B=function(){var e="rf_user_id",t=h()?m(e):null;if(!t){t="rf_"+Math.random().toString(36).slice(2,11)+"_"+Date.now().toString(36);if(h())v(e,t)}return t},D=function(){return{visitor_id:B(),user_agent:navigator.userAgent||"",url:location.href,referrer:document.referrer,timestamp:new Date().toISOString(),viewport:{width:window.innerWidth,height:window.innerHeight}}},E=function(e){if(!e||!e.conversion_url)return;try{if(sessionStorage.getItem(f)==="1"){g("Conversion already tracked");return}}catch(_){}var t=e.conversion_url,r=window.location.pathname,n=window.location.href.split("?")[0].split("#")[0],o="";try{var a=new URL(t,window.location.origin);o=a.pathname}catch(_){o=t.split("?")[0].split("#")[0]}var i=r===o||n.indexOf(o)!==-1||r.indexOf(o)!==-1||n===t||n.indexOf(t)!==-1;if(i){g("üéØ Conversion page detected!",{currentPath:r,conversionPath:o,currentFullUrl:n,conversionUrl:t,value:e.conversion_value});try{sessionStorage.setItem(f,"1")}catch(_){}var c=parseFloat(e.conversion_value)||0;window.RotaFinal.convert(c,{auto:true,url:n,conversion_url:t})}else{g("‚ö†Ô∏è Not on conversion page",{currentPath:r,conversionPath:o,currentFullUrl:n,conversionUrl:t})}};(function(){if(!w())return;try{if(sessionStorage.getItem(d)==="1"){return}}catch(_){}var e=x();if(e){g("üì¶ Using cached variant",e);var t=e.final_url||e.redirect_url;if(t&&!e.is_control){g("‚ö° Cached variant redirect",t);C(t);return}}g("‚ö° First visit - fetching variant");var n=new XMLHttpRequest();n.open("POST",t+"/api/experiments/"+e+"/assign",false);n.setRequestHeader("Content-Type","application/json");n.setRequestHeader("Authorization","Bearer "+r);n.setRequestHeader("X-RF-Version",n);try{n.send(JSON.stringify(D()));if(n.status===200){var a=JSON.parse(n.responseText);if(a.variant){g("‚úÖ Variant received",a.variant);v(i,JSON.stringify({v:a.variant,t:Date.now()}));if(a.experiment){z(a.experiment);A(e,a.variant)}var o=a.variant.final_url||a.variant.redirect_url;if(o&&!a.variant.is_control){g("‚ö° First visit redirect",o);C(o)}}else{g("‚ö†Ô∏è No variant in response",a)}}else{g("‚ö†Ô∏è API returned status",n.status)}}catch(e){g("Sync assign error",e)}}());var F=function(){try{return navigator.userAgent||""}catch(_){return""}},G=function(){return new Date().toISOString()},H=function(e,t,r){r=r||3;var n=new AbortController(),o=setTimeout(function(){n.abort()},5000),a={"Content-Type":"application/json","Authorization":"Bearer "+r,"X-RF-Version":n},i=Object.assign({headers:a,signal:n.signal},t||{});return fetch(e,i).then(function(e){clearTimeout(o);if(!e.ok)throw new Error("HTTP "+e.status);return e.json()}).catch(function(e){clearTimeout(o);if(r<=1)throw e;var t=Math.min(600,100*Math.pow(2,3-r))+Math.random()*120;return new Promise(function(e){setTimeout(e,t)}).then(function(){return H(e,t,r-1)})})},I=function(){var e=F().toLowerCase();return/bot|crawler|spider|crawling|archiver|scraper|slurp|wget|curl|httpunit|preview|prerender|headless/i.test(e)},J=function(e){if(!h())return;v(i,JSON.stringify({v:e,t:Date.now()}))},K={cachedVariant:null,applyVariant:function(e){if(!e)return;this.cachedVariant=e;document.documentElement.setAttribute("data-rf-experiment",e);document.documentElement.setAttribute("data-rf-variant",e.name||"control");document.documentElement.setAttribute("data-rf-user",B());' + applyChangesCode + '}},L=null,M=function(){if(K.cachedVariant)return Promise.resolve({variant:K.cachedVariant});if(L)return L;var e=x();if(e){K.cachedVariant=e;return Promise.resolve({variant:e})}try{if(sessionStorage.getItem(d)==="1"){return Promise.resolve({variant:{name:"redirected",skip:true}})}}catch(_){}L=H(t+"/api/experiments/"+e+"/assign",{method:"POST",body:JSON.stringify(D())}).then(function(t){if(t&&t.variant){K.cachedVariant=t.variant;J(t.variant);if(t.experiment){z(t.experiment);A(e,t.variant)}}return t}).catch(function(e){g("Assign error",e);return{variant:{name:"control",is_control:true,error:true}}}).finally(function(){L=null});return L},N={eventQueue:[],_clickBuffer:[],_clickTimer:null,baseEvent:function(t,r){return{experiment_id:e,visitor_id:B(),variant_id:K.cachedVariant&&K.cachedVariant.id||null,variant:K.cachedVariant&&K.cachedVariant.name||null,event_type:t,properties:r||{},timestamp:G(),url:location.href,referrer:document.referrer,user_agent:F()}},track:function(e,n){var o=this.baseEvent(e,n);g("Track",e,o);return H(t+"/api/track",{method:"POST",body:JSON.stringify(o)}).catch(function(e){N.enqueue(o)})},trackBufferedClick:function(e,t){this._clickBuffer.push(this.baseEvent(e,t));if(this._clickTimer)return;this._clickTimer=setTimeout(function(){N._clickTimer=null;N.flushClicks()},150)},flushClicks:function(){var e=N._clickBuffer.splice(0);if(!e.length)return;H(t+"/api/track/batch",{method:"POST",body:JSON.stringify({events:e})}).catch(function(){N.eventQueue.push.apply(N.eventQueue,e);O()})},setupClickTracking:function(){document.addEventListener("click",function(e){var t=e.target&&e.target.closest&&e.target.closest("[data-rf-track]");if(!t)return;var r=t.getAttribute("data-rf-track")||"click",n={};Array.prototype.forEach.call(t.attributes,function(e){if(e.name.indexOf("data-rf-")===0&&e.name!=="data-rf-track"){n[e.name.replace("data-rf-","")]=e.value}});var o={element:t.tagName.toLowerCase(),text:(t.textContent||"").trim().slice(0,100)};Object.assign(o,n);N.trackBufferedClick(r,o)},true)},trackPageview:function(){this.track("page_view",{title:document.title,path:location.pathname,search:location.search})},enqueue:function(e){N.eventQueue.push(e);O()},flushQueue:function(){if(!N.eventQueue.length)return;var e=N.eventQueue.splice(0);O();H(t+"/api/track/batch",{method:"POST",body:JSON.stringify({events:e})}).catch(function(){N.eventQueue.unshift.apply(N.eventQueue,e);O()})}' + conversionTrackingCode + '},O=function(){if(!h())return;try{v(c,JSON.stringify(N.eventQueue))}catch(_){}},P=function(){if(!h())return[];try{return JSON.parse(m(c)||"[]")}catch(_){return[]}};N.eventQueue=P();var Q=N.eventQueue.push.bind(N.eventQueue);N.eventQueue.push=function(){var e=Q.apply(N.eventQueue,arguments);O();return e};function R(){if(!N.eventQueue.length)return;var e=JSON.stringify({events:N.eventQueue});if(navigator.sendBeacon){navigator.sendBeacon(t+"/api/track/batch",new Blob([e],{type:"application/json"}));N.eventQueue=[];O();return}N.flushQueue()}document.addEventListener("visibilitychange",function(){if(document.visibilityState==="hidden")R()});window.addEventListener("beforeunload",R);function S(){document.body.setAttribute("data-rf-ready","true");var e=document.querySelector("style[data-rf-antiflicker]");if(e)setTimeout(function(){try{e.remove()}catch(_){}},80);g("Page visible")}function T(e){return window.requestIdleCallback?requestIdleCallback(e,{timeout:500}):setTimeout(e,50)}function U(){if(!w()){S();return}if(I()){S();return}g("Init");var e=setTimeout(S,a);M().then(function(t){clearTimeout(e);if(t&&t.variant&&!t.variant.skip){K.cachedVariant=t.variant;if(t.experiment){z(t.experiment);A(e,t.variant);E(t.experiment)}K.applyVariant(t.variant);N.trackPageview();' + setupConversionCode + 'S()}else{S()}}).catch(function(e){clearTimeout(e);S()});T(function(){N.setupClickTracking();var t=y();if(t){E(t)}})}window.RotaFinal={track:function(e,t){return N.track(e,t)},convert:function(e,t){return N.track("conversion",Object.assign({value:e||' + conversionValue + '},t))},getVariant:function(){return K.cachedVariant},getUserId:B,reload:function(){K.cachedVariant=null;v(i,"");v(s,"");v(l,"");try{sessionStorage.removeItem(d);sessionStorage.removeItem(f)}catch(_){}location.reload()},setDebug:function(e){e?localStorage.setItem("rf_debug","1"):localStorage.removeItem("rf_debug");o=e;location.reload()}};if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",U)}else{U()}}();';

        // Testar o c√≥digo gerado
        console.log('üß™ Testando c√≥digo gerado...');
        console.log('C√≥digo gerado:', inlineSDK.substring(0, 200) + '...');
        
        // Verificar se as vari√°veis est√£o corretas
        const testMatch = inlineSDK.match(/var e="([^"]+)",t="([^"]+)",r="([^"]+)"/);
        if (testMatch) {
            const [, expId, baseUrl, apiKey] = testMatch;
            console.log('‚úÖ Vari√°veis extra√≠das:');
            console.log('  experimentId:', expId);
            console.log('  baseUrl:', baseUrl);
            console.log('  apiKey:', apiKey.substring(0, 10) + '...');
            
            // Verificar se est√£o corretas
            const results = document.getElementById('test-results');
            results.innerHTML = `
                <h2>Resultado do Teste:</h2>
                <p><strong>experimentId:</strong> ${expId} ${expId === experimentId ? '‚úÖ' : '‚ùå'}</p>
                <p><strong>baseUrl:</strong> ${baseUrl} ${baseUrl === baseUrl ? '‚úÖ' : '‚ùå'}</p>
                <p><strong>apiKey:</strong> ${apiKey.substring(0, 10)}... ${apiKey === apiKey ? '‚úÖ' : '‚ùå'}</p>
            `;
        } else {
            console.error('‚ùå N√£o foi poss√≠vel extrair as vari√°veis do c√≥digo');
            document.getElementById('test-results').innerHTML = '<p style="color: red;">‚ùå Erro ao extrair vari√°veis</p>';
        }
    </script>
</body>
</html>
