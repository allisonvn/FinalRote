<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CÃ³digo Corrigido - Experimento Esmalt</title>
</head>
<body>
    <h1>CÃ³digo Corrigido para o Experimento Esmalt</h1>
    <p>Este cÃ³digo deve substituir o cÃ³digo que estÃ¡ sendo gerado automaticamente:</p>
    
    <pre style="background: #1e1e1e; color: #d4d4d4; padding: 20px; overflow-x: auto;">
<!-- RotaFinal SDK v3.0.1 - Esmalt (CORRIGIDO) -->
<!-- Experimento ID: 21d2c999-7cbc-4985-87a3-3780fe938eb0 -->
<!-- Tipo: SPLIT_URL | Algoritmo: THOMPSON_SAMPLING -->

<link rel="preconnect" href="https://rotafinal.com.br">
<link rel="dns-prefetch" href="https://rotafinal.com.br">

<style data-rf-antiflicker>
body:not([data-rf-ready]){opacity:0;visibility:hidden}
body[data-rf-ready]{opacity:1;visibility:visible;transition:opacity .1s ease-out}
</style>

<script>
!function(){"use strict";var experimentId="21d2c999-7cbc-4985-87a3-3780fe938eb0",baseUrl="https://rotafinal.com.br",apiKey="pk_ea145f98f99dc7df53fd4faeedba160f",version="3.0.1-auto-conversion",debugMode=false,ANTIFLICKER_TIMEOUT=120,VAR_KEY="rf_variant_"+experimentId,EXP_KEY="rf_experiment_"+experimentId,ASSIGN_KEY="rotafinal_exp_"+experimentId,QKEY="rf_queue_"+experimentId,VAR_TTL=18e5,REDIRECT_KEY="rf_redirected_"+experimentId,CONVERSION_TRACKED_KEY="rf_conversion_tracked_"+experimentId,EXPERIMENT_URLS=["/elementor-595/","/elementor-695/"],log=function(msg,data){if(debugMode||window.localStorage.getItem("rf_debug")){try{console.log("[RotaFinal v3.0.1]",msg,data||"")}catch(_){}}},hasLS=function(){try{var k="__t";localStorage.setItem(k,"1");localStorage.removeItem(k);return true}catch(_){return false}},getLS=function(k){try{return localStorage.getItem(k)}catch(_){return null}},setLS=function(k,v){try{localStorage.setItem(k,v)}catch(_){}},isValidExperimentUrl=function(){if(!EXPERIMENT_URLS||EXPERIMENT_URLS.length===0)return true;var currentPath=window.location.pathname;for(var i=0;i<EXPERIMENT_URLS.length;i++){var validUrl=EXPERIMENT_URLS[i];if(currentPath===validUrl||currentPath.startsWith(validUrl)){return true}}return false},loadVariantCache=function(){if(!hasLS())return null;try{var raw=getLS(VAR_KEY);if(!raw)return null;var obj=JSON.parse(raw);if(Date.now()-obj.t>VAR_TTL)return null;return obj.v||null}catch(_){return null}},loadExperimentCache=function(){if(!hasLS())return null;try{var raw=getLS(EXP_KEY);if(!raw)return null;var obj=JSON.parse(raw);if(Date.now()-obj.t>VAR_TTL)return null;return obj.e||null}catch(_){return null}},saveExperimentCache=function(expData){if(!hasLS())return;setLS(EXP_KEY,JSON.stringify({e:expData,t:Date.now()}))},saveAssignmentData=function(variant,expData){if(!hasLS())return;var assignData={experimentId:experimentId,experiment_id:experimentId,variantId:variant.id,variant_id:variant.id,variantName:variant.name,variant:variant.name,visitorId:getUserId(),visitor_id:getUserId(),timestamp:Date.now()};setLS(ASSIGN_KEY,JSON.stringify(assignData));log("ðŸ’¾ Assignment data saved",assignData);var originData={url:window.location.href,title:document.title,timestamp:Date.now()};setLS("rotafinal_origin_"+experimentId,JSON.stringify(originData));log("ðŸ’¾ Origin page data saved",originData)},doRedirect=function(url){if(!url)return false;var currentUrl=window.location.href.split("?")[0].split("#")[0];var targetUrl=url.split("?")[0].split("#")[0];if(targetUrl===currentUrl)return false;log("âš¡ REDIRECT",url);try{sessionStorage.setItem(REDIRECT_KEY,"1")}catch(_){}window.location.replace(url);return true},getUserId=function(){var k="rf_user_id";var v=hasLS()?getLS(k):null;if(!v){v="rf_"+Math.random().toString(36).slice(2,11)+"_"+Date.now().toString(36);if(hasLS())setLS(k,v)}return v},buildPayload=function(){return{visitor_id:getUserId(),user_agent:navigator.userAgent||"",url:location.href,referrer:document.referrer,timestamp:new Date().toISOString(),viewport:{width:window.innerWidth,height:window.innerHeight}}},checkAndTrackConversion=function(expData){if(!expData||!expData.conversion_url)return;try{if(sessionStorage.getItem(CONVERSION_TRACKED_KEY)==="1"){log("Conversion already tracked");return}}catch(_){}var conversionUrl=expData.conversion_url;var currentPath=window.location.pathname;var currentFullUrl=window.location.href.split("?")[0].split("#")[0];var conversionPath="";try{var urlObj=new URL(conversionUrl,window.location.origin);conversionPath=urlObj.pathname}catch(_){conversionPath=conversionUrl.split("?")[0].split("#")[0]}var isOnConversionPage=currentPath===conversionPath||currentFullUrl.indexOf(conversionPath)!==-1||currentPath.indexOf(conversionPath)!==-1;if(isOnConversionPage){log("ðŸŽ¯ Conversion page detected!",{currentPath:currentPath,conversionPath:conversionPath,value:expData.conversion_value});try{sessionStorage.setItem(CONVERSION_TRACKED_KEY,"1")}catch(_){}var conversionValue=parseFloat(expData.conversion_value)||0;window.RotaFinal.convert(conversionValue,{auto:true,url:currentFullUrl,conversion_url:conversionUrl})}};(function(){if(!isValidExperimentUrl())return;try{if(sessionStorage.getItem(REDIRECT_KEY)==="1"){return}}catch(_){}var cached=loadVariantCache();if(cached){var redirectUrl=cached.final_url||cached.redirect_url;if(redirectUrl&&!cached.is_control){doRedirect(redirectUrl);return}}log("âš¡ First visit - fetching variant");var xhr=new XMLHttpRequest();xhr.open("POST",baseUrl+"/api/experiments/"+experimentId+"/assign",false);xhr.setRequestHeader("Content-Type","application/json");xhr.setRequestHeader("Authorization","Bearer "+apiKey);xhr.setRequestHeader("X-RF-Version",version);try{xhr.send(JSON.stringify(buildPayload()));if(xhr.status===200){var response=JSON.parse(xhr.responseText);if(response.variant){setLS(VAR_KEY,JSON.stringify({v:response.variant,t:Date.now()}));if(response.experiment){saveExperimentCache(response.experiment);saveAssignmentData(response.variant,response.experiment)}var redirectUrl=response.variant.final_url||response.variant.redirect_url;if(redirectUrl&&!response.variant.is_control){log("âš¡ First visit redirect",redirectUrl);doRedirect(redirectUrl)}}}}catch(err){log("Sync assign error",err)}}());var safeUA=function(){try{return navigator.userAgent||""}catch(_){return""}},nowISO=function(){return new Date().toISOString()},apiCall=function(url,options,tries){tries=tries||3;var controller=new AbortController();var timeoutId=setTimeout(function(){controller.abort()},5000);var headers={"Content-Type":"application/json","Authorization":"Bearer "+apiKey,"X-RF-Version":version};var opts=Object.assign({headers:headers,signal:controller.signal},options||{});return fetch(url,opts).then(function(r){clearTimeout(timeoutId);if(!r.ok)throw new Error("HTTP "+r.status);return r.json()}).catch(function(err){clearTimeout(timeoutId);if(tries<=1)throw err;var backoff=Math.min(600,100*Math.pow(2,3-tries))+Math.random()*120;return new Promise(function(res){setTimeout(res,backoff)}).then(function(){return apiCall(url,options,tries-1)})})},isBot=function(){var ua=safeUA().toLowerCase();return/bot|crawler|spider|crawling|archiver|scraper|slurp|wget|curl|httpunit|preview|prerender|headless/i.test(ua)},saveVariantCache=function(variant){if(!hasLS())return;setLS(VAR_KEY,JSON.stringify({v:variant,t:Date.now()}))},experiment={cachedVariant:null,applyVariant:function(variant){if(!variant)return;this.cachedVariant=variant;document.documentElement.setAttribute("data-rf-experiment",experimentId);document.documentElement.setAttribute("data-rf-variant",variant.name||"control");document.documentElement.setAttribute("data-rf-user",getUserId());}},assignInFlight=null,assignOnce=function(){if(experiment.cachedVariant)return Promise.resolve({variant:experiment.cachedVariant});if(assignInFlight)return assignInFlight;var cached=loadVariantCache();if(cached){experiment.cachedVariant=cached;return Promise.resolve({variant:cached})}try{if(sessionStorage.getItem(REDIRECT_KEY)==="1"){return Promise.resolve({variant:{name:"redirected",skip:true}})}}catch(_){}assignInFlight=apiCall(baseUrl+"/api/experiments/"+experimentId+"/assign",{method:"POST",body:JSON.stringify(buildPayload())}).then(function(r){if(r&&r.variant){experiment.cachedVariant=r.variant;saveVariantCache(r.variant);if(r.experiment){saveExperimentCache(r.experiment);saveAssignmentData(r.variant,r.experiment)}}return r}).catch(function(err){return{variant:{name:"control",is_control:true,error:true}}}).finally(function(){assignInFlight=null});return assignInFlight},tracking={eventQueue:[],_clickBuffer:[],_clickTimer:null,baseEvent:function(type,props){return{experiment_id:experimentId,visitor_id:getUserId(),variant_id:experiment.cachedVariant&&experiment.cachedVariant.id||null,variant:experiment.cachedVariant&&experiment.cachedVariant.name||null,event_type:type,properties:props||{},timestamp:nowISO(),url:location.href,referrer:document.referrer,user_agent:safeUA()}},track:function(eventName,properties){var ev=this.baseEvent(eventName,properties);log("Track",eventName,ev);return apiCall(baseUrl+"/api/track",{method:"POST",body:JSON.stringify(ev)}).catch(function(err){tracking.enqueue(ev)})},trackBufferedClick:function(eventName,props){this._clickBuffer.push(this.baseEvent(eventName,props));if(this._clickTimer)return;this._clickTimer=setTimeout(function(){tracking._clickTimer=null;tracking.flushClicks()},150)},flushClicks:function(){var events=tracking._clickBuffer.splice(0);if(!events.length)return;apiCall(baseUrl+"/api/track/batch",{method:"POST",body:JSON.stringify({events:events})}).catch(function(){tracking.eventQueue.push.apply(tracking.eventQueue,events);persistQueue()})},setupClickTracking:function(){document.addEventListener("click",function(event){var el=event.target&&event.target.closest&&event.target.closest("[data-rf-track]");if(!el)return;var eventName=el.getAttribute("data-rf-track")||"click";var attributes={};Array.prototype.forEach.call(el.attributes,function(attr){if(attr.name.indexOf("data-rf-")===0&&attr.name!=="data-rf-track"){attributes[attr.name.replace("data-rf-","")]=attr.value}});var clickData={element:el.tagName.toLowerCase(),text:(el.textContent||"").trim().slice(0,100)};Object.assign(clickData,attributes);tracking.trackBufferedClick(eventName,clickData)},true)},trackPageview:function(){this.track("page_view",{title:document.title,path:location.pathname,search:location.search})},enqueue:function(ev){tracking.eventQueue.push(ev);persistQueue()},flushQueue:function(){if(!tracking.eventQueue.length)return;var events=tracking.eventQueue.splice(0);persistQueue();apiCall(baseUrl+"/api/track/batch",{method:"POST",body:JSON.stringify({events:events})}).catch(function(){tracking.eventQueue.unshift.apply(tracking.eventQueue,events);persistQueue()})}},loadQueue=function(){if(!hasLS())return[];try{return JSON.parse(getLS(QKEY)||"[]")}catch(_){return[]}},persistQueue=function(){if(!hasLS())return;try{setLS(QKEY,JSON.stringify(tracking.eventQueue))}catch(_){}};tracking.eventQueue=loadQueue();var _push=tracking.eventQueue.push.bind(tracking.eventQueue);tracking.eventQueue.push=function(){var r=_push.apply(tracking.eventQueue,arguments);persistQueue();return r};function flushWithBeacon(){if(!tracking.eventQueue.length)return;var payload=JSON.stringify({events:tracking.eventQueue});if(navigator.sendBeacon){var ok=navigator.sendBeacon(baseUrl+"/api/track/batch",new Blob([payload],{type:"application/json"}));if(ok){tracking.eventQueue=[];persistQueue();return}}tracking.flushQueue()}document.addEventListener("visibilitychange",function(){if(document.visibilityState==="hidden")flushWithBeacon()});window.addEventListener("beforeunload",flushWithBeacon);function showPage(){document.body.setAttribute("data-rf-ready","true");var style=document.querySelector("style[data-rf-antiflicker]");if(style)setTimeout(function(){try{style.remove()}catch(_){}},80);log("Page visible")}function idle(fn){return window.requestIdleCallback?requestIdleCallback(fn,{timeout:500}):setTimeout(fn,50)}function init(){if(!isValidExperimentUrl()){showPage();return}if(isBot()){showPage();return}log("Init");var tId=setTimeout(showPage,ANTIFLICKER_TIMEOUT);assignOnce().then(function(r){clearTimeout(tId);if(r&&r.variant&&!r.variant.skip){experiment.cachedVariant=r.variant;if(r.experiment){saveExperimentCache(r.experiment);saveAssignmentData(r.variant,r.experiment);checkAndTrackConversion(r.experiment)}experiment.applyVariant(r.variant);tracking.trackPageview();showPage()}else{showPage()}}).catch(function(err){clearTimeout(tId);showPage()});idle(function(){tracking.setupClickTracking();var cachedExp=loadExperimentCache();if(cachedExp){checkAndTrackConversion(cachedExp)}})}window.RotaFinal={track:function(eventName,properties){return tracking.track(eventName,properties)},convert:function(value,properties){return tracking.track("conversion",Object.assign({value:value||0},properties))},getVariant:function(){return experiment.cachedVariant},getUserId:getUserId,reload:function(){experiment.cachedVariant=null;setLS(VAR_KEY,"");setLS(EXP_KEY,"");setLS(ASSIGN_KEY,"");try{sessionStorage.removeItem(REDIRECT_KEY);sessionStorage.removeItem(CONVERSION_TRACKED_KEY)}catch(_){}location.reload()},setDebug:function(enabled){enabled?localStorage.setItem("rf_debug","1"):localStorage.removeItem("rf_debug");debugMode=enabled;location.reload()}};if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",init)}else{init()}}();
</script>

<!-- âœ… TESTE SPLIT URL -->
<!-- ðŸ”§ CORREÃ‡Ã•ES APLICADAS:
     1. Salvamento dos dados de atribuiÃ§Ã£o no localStorage com a chave correta
     2. FunÃ§Ã£o saveAssignmentData() adicionada
     3. Dados salvos no formato esperado pelo conversion-tracker.js
     4. Salvamento da pÃ¡gina de origem para rastreamento correto
-->
    </pre>
    
    <h2>O que foi corrigido:</h2>
    <ol>
        <li><strong>Adicionada funÃ§Ã£o saveAssignmentData():</strong> Salva os dados de atribuiÃ§Ã£o no localStorage com a chave correta (rotafinal_exp_)</li>
        <li><strong>Salvamento da pÃ¡gina de origem:</strong> Salva a URL da pÃ¡gina onde o experimento foi iniciado</li>
        <li><strong>Chamadas para saveAssignmentData():</strong> Adicionadas em dois lugares:
            <ul>
                <li>No carregamento sÃ­ncrono inicial</li>
                <li>Na funÃ§Ã£o assignOnce() assÃ­ncrona</li>
            </ul>
        </li>
        <li><strong>Dados completos salvos:</strong> Todos os campos necessÃ¡rios para o conversion-tracker.js funcionar</li>
    </ol>
    
    <h2>Como testar:</h2>
    <ol>
        <li>Substitua o cÃ³digo atual pelo cÃ³digo corrigido acima</li>
        <li>Limpe o localStorage e cookies do navegador</li>
        <li>Acesse a pÃ¡gina com o experimento</li>
        <li>Abra o console (F12) e execute: <code>localStorage.getItem('rotafinal_exp_21d2c999-7cbc-4985-87a3-3780fe938eb0')</code></li>
        <li>VocÃª deve ver os dados de atribuiÃ§Ã£o salvos</li>
        <li>Acesse a pÃ¡gina de conversÃ£o - a conversÃ£o deve ser rastreada automaticamente</li>
    </ol>
</body>
</html>
