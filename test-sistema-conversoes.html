<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Sistema de Convers√µes Autom√°tico - Rota Final</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
        }
        .success { background: #d1fae5; color: #065f46; }
        .info { background: #dbeafe; color: #1e40af; }
        .warning { background: #fef3c7; color: #92400e; }
        .error { background: #fee2e2; color: #991b1b; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #2563eb; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        .code {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 15px 0;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
        }
        .metric-label {
            font-size: 14px;
            color: #6b7280;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Teste Sistema de Convers√µes Autom√°tico</h1>
            <p>Demonstra√ß√£o do sistema de A/B testing com convers√µes autom√°ticas</p>
        </div>

        <div id="status" class="status info">
            Inicializando sistema...
        </div>

        <div class="metrics" id="metrics" style="display: none;">
            <div class="metric">
                <div class="metric-value" id="visitors">0</div>
                <div class="metric-label">Visitantes</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="conversions">0</div>
                <div class="metric-label">Convers√µes</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="revenue">R$ 0,00</div>
                <div class="metric-label">Receita</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="conversion-rate">0%</div>
                <div class="metric-label">Taxa de Convers√£o</div>
            </div>
        </div>

        <div>
            <h3>Teste Manual</h3>
            <button onclick="testAssignment()" id="btn-assign">1. Obter Variante</button>
            <button onclick="testPageView()" id="btn-pageview" disabled>2. Simular Page View</button>
            <button onclick="testConversion()" id="btn-conversion" disabled>3. Simular Convers√£o</button>
            <button onclick="loadMetrics()" id="btn-metrics" disabled>4. Carregar M√©tricas</button>
        </div>

        <div>
            <h3>Teste Autom√°tico (SDK)</h3>
            <p>Este teste simula o uso real do SDK JavaScript:</p>
            <div class="code" id="sdk-code">
// SDK ser√° carregado automaticamente
const rf = new RotaFinal({
  apiKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
  debug: true
});

// Obter variante (auto salva conversion_url)
rf.getVariant('teste-homepage-nova').then(variant => {
  console.log('Variante atribu√≠da:', variant);
  // Convers√£o √© AUTOM√ÅTICA quando visitar /obrigado
});
            </div>
            <button onclick="testSDK()" id="btn-sdk">Testar SDK Autom√°tico</button>
        </div>

        <div>
            <h3>Logs do Sistema</h3>
            <div class="code" id="logs" style="height: 200px; overflow-y: auto;">
                Aguardando logs...
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://ynarsxvvonabpoirogse.supabase.co/functions/v1';
        const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InluYXJzeHZ2b25hYnBvaXJvZ3NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM4NTM0OTgsImV4cCI6MjA0OTQyOTQ5OH0.LrO7-tR2kQzvj6tpXWaII5eeOKVOSjwGmuIR_k41yBM';
        
        let currentVariant = null;
        let visitorId = 'demo_visitor_' + Math.random().toString(36).substr(2, 9);

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logs.textContent += logEntry;
            logs.scrollTop = logs.scrollHeight;
            
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        async function testAssignment() {
            try {
                log('Obtendo variante do experimento...', 'info');
                
                const response = await fetch(`${API_URL}/assign-variant`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        experiment_key: 'teste-homepage-nova',
                        visitor_id: visitorId,
                        context: {
                            page_url: window.location.href,
                            user_agent: navigator.userAgent
                        }
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    currentVariant = data;
                    log(`‚úÖ Variante atribu√≠da: ${data.variant_name} (${data.variant_key})`, 'success');
                    log(`üìä Experimento: ${data.experiment.name}`, 'info');
                    log(`üéØ URL de convers√£o: ${data.experiment.conversion_url}`, 'info');
                    log(`üí∞ Valor da convers√£o: R$ ${data.experiment.conversion_value}`, 'info');
                    
                    document.getElementById('btn-pageview').disabled = false;
                    document.getElementById('btn-assign').disabled = true;
                } else {
                    throw new Error(data.error || 'Erro ao obter variante');
                }
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function testPageView() {
            try {
                log('Enviando evento de page view...', 'info');
                
                const response = await fetch(`${API_URL}/track-event`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        events: [{
                            visitor_id: visitorId,
                            event_type: 'page_view',
                            event_name: 'homepage_visit',
                            properties: {
                                page_url: window.location.href,
                                referrer: document.referrer,
                                variant: currentVariant.variant_name
                            },
                            experiment_key: 'teste-homepage-nova'
                        }]
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ Page view rastreado com sucesso`, 'success');
                    document.getElementById('btn-conversion').disabled = false;
                    document.getElementById('btn-pageview').disabled = true;
                } else {
                    throw new Error(data.error || 'Erro ao rastrear page view');
                }
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function testConversion() {
            try {
                log('Simulando convers√£o...', 'info');
                
                const response = await fetch(`${API_URL}/track-event`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        events: [{
                            visitor_id: visitorId,
                            event_type: 'conversion',
                            event_name: 'purchase',
                            properties: {
                                success_page_url: currentVariant.experiment.conversion_url,
                                conversion_type: currentVariant.experiment.conversion_type,
                                variant: currentVariant.variant_name
                            },
                            value: currentVariant.experiment.conversion_value,
                            experiment_key: 'teste-homepage-nova'
                        }]
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ Convers√£o rastreada com sucesso!`, 'success');
                    log(`üí∞ Valor: R$ ${currentVariant.experiment.conversion_value}`, 'success');
                    document.getElementById('btn-metrics').disabled = false;
                    document.getElementById('btn-conversion').disabled = true;
                } else {
                    throw new Error(data.error || 'Erro ao rastrear convers√£o');
                }
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function loadMetrics() {
            try {
                log('Carregando m√©tricas do experimento...', 'info');
                
                // Simular carregamento de m√©tricas
                // Em um sistema real, voc√™ faria uma chamada para obter as m√©tricas
                const mockMetrics = {
                    visitors: Math.floor(Math.random() * 100) + 50,
                    conversions: Math.floor(Math.random() * 20) + 5,
                    revenue: Math.floor(Math.random() * 1000) + 200
                };
                
                const conversionRate = mockMetrics.visitors > 0 
                    ? ((mockMetrics.conversions / mockMetrics.visitors) * 100).toFixed(2)
                    : 0;
                
                document.getElementById('visitors').textContent = mockMetrics.visitors;
                document.getElementById('conversions').textContent = mockMetrics.conversions;
                document.getElementById('revenue').textContent = `R$ ${mockMetrics.revenue.toFixed(2)}`;
                document.getElementById('conversion-rate').textContent = `${conversionRate}%`;
                
                document.getElementById('metrics').style.display = 'grid';
                log(`üìä M√©tricas carregadas: ${mockMetrics.visitors} visitantes, ${mockMetrics.conversions} convers√µes`, 'success');
                
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function testSDK() {
            try {
                log('Testando SDK JavaScript...', 'info');
                
                // Simular carregamento do SDK
                const sdkCode = `
// Simula√ß√£o do SDK RotaFinal
class RotaFinal {
    constructor(config) {
        this.apiKey = config.apiKey;
        this.apiUrl = config.apiUrl || 'https://ynarsxvvonabpoirogse.supabase.co/functions/v1';
        this.debug = config.debug;
    }
    
    async getVariant(experimentKey) {
        const response = await fetch(\`\${this.apiUrl}/assign-variant\`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': \`Bearer \${this.apiKey}\`
            },
            body: JSON.stringify({
                experiment_key: experimentKey,
                visitor_id: '${visitorId}',
                context: { page_url: window.location.href }
            })
        });
        return response.json();
    }
    
    async track(eventType, eventName, properties, value, experimentKey) {
        const response = await fetch(\`\${this.apiUrl}/track-event\`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': \`Bearer \${this.apiKey}\`
            },
            body: JSON.stringify({
                events: [{
                    visitor_id: '${visitorId}',
                    event_type: eventType,
                    event_name: eventName,
                    properties,
                    value,
                    experiment_key: experimentKey
                }]
            })
        });
        return response.json();
    }
}

// Inicializar SDK
const rf = new RotaFinal({
    apiKey: '${API_KEY}',
    debug: true
});

// Obter variante
rf.getVariant('teste-homepage-nova').then(variant => {
    console.log('Variante atribu√≠da:', variant);
    // Convers√£o autom√°tica quando visitar URL de convers√£o
    if (window.location.href.includes('obrigado')) {
        rf.track('conversion', 'purchase', {
            success_page_url: window.location.href
        }, variant.experiment.conversion_value, 'teste-homepage-nova');
    }
});
                `;
                
                document.getElementById('sdk-code').textContent = sdkCode;
                log('‚úÖ SDK simulado carregado com sucesso!', 'success');
                log('üí° Em um site real, o SDK detectaria automaticamente a convers√£o', 'info');
                
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        // Inicializar
        log('Sistema inicializado. Clique em "Obter Variante" para come√ßar.', 'info');
    </script>
</body>
</html>
