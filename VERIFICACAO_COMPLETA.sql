-- ==================================================================================
-- VERIFICA√á√ÉO COMPLETA DO SISTEMA A/B TESTING
-- ==================================================================================
-- Execute este script para verificar se tudo foi corrigido corretamente
-- ==================================================================================

\echo ''
\echo 'üîç =========================================='
\echo 'üîç VERIFICA√á√ÉO COMPLETA DO SISTEMA'
\echo 'üîç =========================================='
\echo ''

-- ==================================================================================
-- PARTE 1: VERIFICAR ESTRUTURA DAS TABELAS
-- ==================================================================================

\echo 'üìã PARTE 1: Verificando estrutura das tabelas...'
\echo ''

-- 1.1 Verificar tabela experiments
\echo '1.1 Tabela EXPERIMENTS:'
SELECT
    'experiments' as tabela,
    COUNT(*) FILTER (WHERE column_name = 'algorithm') as tem_algorithm,
    COUNT(*) FILTER (WHERE column_name = 'target_url') as tem_target_url,
    COUNT(*) FILTER (WHERE column_name = 'conversion_url') as tem_conversion_url,
    COUNT(*) FILTER (WHERE column_name = 'conversion_type') as tem_conversion_type,
    COUNT(*) FILTER (WHERE column_name = 'conversion_value') as tem_conversion_value,
    COUNT(*) FILTER (WHERE column_name = 'duration_days') as tem_duration_days,
    CASE
        WHEN COUNT(*) FILTER (WHERE column_name IN ('algorithm', 'target_url', 'conversion_url', 'conversion_type', 'conversion_value', 'duration_days')) = 6
        THEN '‚úÖ OK - Todas as colunas existem'
        ELSE '‚ùå ERRO - Faltam ' || (6 - COUNT(*) FILTER (WHERE column_name IN ('algorithm', 'target_url', 'conversion_url', 'conversion_type', 'conversion_value', 'duration_days'))) || ' colunas'
    END as status
FROM information_schema.columns
WHERE table_name = 'experiments';

\echo ''

-- 1.2 Verificar tabela variant_stats
\echo '1.2 Tabela VARIANT_STATS:'
SELECT
    'variant_stats' as tabela,
    EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'variant_stats') as tabela_existe,
    COUNT(*) FILTER (WHERE column_name = 'visitors') as tem_visitors,
    COUNT(*) FILTER (WHERE column_name = 'conversions') as tem_conversions,
    COUNT(*) FILTER (WHERE column_name = 'revenue') as tem_revenue,
    COUNT(*) FILTER (WHERE column_name = 'last_updated') as tem_last_updated,
    CASE
        WHEN NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'variant_stats')
        THEN '‚ùå ERRO - Tabela n√£o existe'
        WHEN COUNT(*) FILTER (WHERE column_name IN ('visitors', 'conversions', 'revenue', 'last_updated')) = 4
        THEN '‚úÖ OK - Todas as colunas existem'
        ELSE '‚ùå ERRO - Faltam ' || (4 - COUNT(*) FILTER (WHERE column_name IN ('visitors', 'conversions', 'revenue', 'last_updated'))) || ' colunas'
    END as status
FROM information_schema.columns
WHERE table_name = 'variant_stats';

\echo ''

-- 1.3 Verificar tabela events
\echo '1.3 Tabela EVENTS:'
SELECT
    'events' as tabela,
    COUNT(*) FILTER (WHERE column_name = 'variant_id') as tem_variant_id,
    COUNT(*) FILTER (WHERE column_name = 'event_data') as tem_event_data,
    COUNT(*) FILTER (WHERE column_name = 'value') as tem_value,
    COUNT(*) FILTER (WHERE column_name = 'event_type') as tem_event_type,
    CASE
        WHEN COUNT(*) FILTER (WHERE column_name IN ('variant_id', 'event_data', 'value', 'event_type')) = 4
        THEN '‚úÖ OK - Todas as colunas existem'
        ELSE '‚ùå ERRO - Faltam ' || (4 - COUNT(*) FILTER (WHERE column_name IN ('variant_id', 'event_data', 'value', 'event_type'))) || ' colunas'
    END as status
FROM information_schema.columns
WHERE table_name = 'events';

\echo ''

-- 1.4 Verificar tabela assignments
\echo '1.4 Tabela ASSIGNMENTS:'
SELECT
    'assignments' as tabela,
    EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'assignments') as tabela_existe,
    COUNT(*) FILTER (WHERE column_name = 'experiment_id') as tem_experiment_id,
    COUNT(*) FILTER (WHERE column_name = 'variant_id') as tem_variant_id,
    COUNT(*) FILTER (WHERE column_name = 'visitor_id') as tem_visitor_id,
    CASE
        WHEN NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'assignments')
        THEN '‚ùå ERRO - Tabela n√£o existe'
        WHEN COUNT(*) FILTER (WHERE column_name IN ('experiment_id', 'variant_id', 'visitor_id')) = 3
        THEN '‚úÖ OK - Todas as colunas existem'
        ELSE '‚ùå ERRO - Estrutura incompleta'
    END as status
FROM information_schema.columns
WHERE table_name = 'assignments';

\echo ''
\echo '‚úÖ Parte 1 conclu√≠da'
\echo ''

-- ==================================================================================
-- PARTE 2: VERIFICAR FUN√á√ïES RPC
-- ==================================================================================

\echo 'üìã PARTE 2: Verificando fun√ß√µes RPC...'
\echo ''

SELECT
    proname as "Fun√ß√£o RPC",
    CASE
        WHEN proname = 'increment_variant_visitors' THEN '‚úÖ'
        WHEN proname = 'increment_variant_conversions' THEN '‚úÖ'
        WHEN proname = 'get_experiment_stats' THEN '‚úÖ'
        WHEN proname = 'get_daily_conversions' THEN '‚úÖ'
        WHEN proname = 'calculate_significance' THEN '‚úÖ'
        ELSE '‚ö†Ô∏è'
    END as "Status",
    pg_get_functiondef(oid)::text LIKE '%SECURITY DEFINER%' as "Security Definer",
    pronargs as "Num Params"
FROM pg_proc
WHERE proname IN (
    'increment_variant_visitors',
    'increment_variant_conversions',
    'get_experiment_stats',
    'get_daily_conversions',
    'calculate_significance'
)
ORDER BY proname;

\echo ''

-- Verificar total de fun√ß√µes
SELECT
    CASE
        WHEN COUNT(*) = 5 THEN '‚úÖ OK - Todas as 5 fun√ß√µes RPC existem'
        ELSE '‚ùå ERRO - Apenas ' || COUNT(*) || ' de 5 fun√ß√µes encontradas'
    END as "Status Geral das Fun√ß√µes"
FROM pg_proc
WHERE proname IN (
    'increment_variant_visitors',
    'increment_variant_conversions',
    'get_experiment_stats',
    'get_daily_conversions',
    'calculate_significance'
);

\echo ''
\echo '‚úÖ Parte 2 conclu√≠da'
\echo ''

-- ==================================================================================
-- PARTE 3: VERIFICAR TRIGGERS
-- ==================================================================================

\echo 'üìã PARTE 3: Verificando triggers...'
\echo ''

SELECT
    tgname as "Trigger",
    '‚úÖ' as "Status",
    tgrelid::regclass as "Tabela",
    tgtype as "Tipo"
FROM pg_trigger
WHERE tgname = 'trigger_init_variant_stats';

\echo ''

SELECT
    CASE
        WHEN COUNT(*) >= 1 THEN '‚úÖ OK - Trigger de inicializa√ß√£o existe'
        ELSE '‚ùå ERRO - Trigger n√£o encontrado'
    END as "Status Geral dos Triggers"
FROM pg_trigger
WHERE tgname = 'trigger_init_variant_stats';

\echo ''
\echo '‚úÖ Parte 3 conclu√≠da'
\echo ''

-- ==================================================================================
-- PARTE 4: VERIFICAR √çNDICES
-- ==================================================================================

\echo 'üìã PARTE 4: Verificando √≠ndices de performance...'
\echo ''

SELECT
    schemaname as "Schema",
    tablename as "Tabela",
    indexname as "√çndice",
    '‚úÖ' as "Status"
FROM pg_indexes
WHERE tablename IN ('variant_stats', 'events', 'assignments')
  AND indexname LIKE 'idx_%'
ORDER BY tablename, indexname;

\echo ''
\echo '‚úÖ Parte 4 conclu√≠da'
\echo ''

-- ==================================================================================
-- PARTE 5: VERIFICAR DADOS INICIALIZADOS
-- ==================================================================================

\echo 'üìã PARTE 5: Verificando dados inicializados...'
\echo ''

-- 5.1 Contar variant_stats
\echo '5.1 Variant Stats Inicializados:'
SELECT
    COUNT(DISTINCT vs.experiment_id) as "Experimentos com Stats",
    COUNT(vs.id) as "Total Variant Stats",
    COUNT(DISTINCT vs.variant_id) as "Variantes com Stats",
    CASE
        WHEN COUNT(vs.id) > 0 THEN '‚úÖ OK - Dados inicializados'
        ELSE '‚ö†Ô∏è AVISO - Nenhum dado (pode ser normal se n√£o h√° experimentos)'
    END as "Status"
FROM variant_stats vs;

\echo ''

-- 5.2 Verificar se todas as variantes ativas t√™m stats
\echo '5.2 Variantes sem Stats (deveriam ter):'
SELECT
    e.name as "Experimento",
    v.name as "Variante",
    v.is_active as "Ativa",
    '‚ùå Faltando stats' as "Status"
FROM variants v
JOIN experiments e ON e.id = v.experiment_id
WHERE v.is_active = TRUE
  AND NOT EXISTS (
      SELECT 1 FROM variant_stats vs
      WHERE vs.variant_id = v.id AND vs.experiment_id = v.experiment_id
  )
LIMIT 10;

\echo ''

-- Se nenhuma variante sem stats, mostrar mensagem
DO $$
DECLARE
    missing_count INTEGER;
BEGIN
    SELECT COUNT(*) INTO missing_count
    FROM variants v
    WHERE v.is_active = TRUE
      AND NOT EXISTS (
          SELECT 1 FROM variant_stats vs
          WHERE vs.variant_id = v.id AND vs.experiment_id = v.experiment_id
      );

    IF missing_count = 0 THEN
        RAISE NOTICE '‚úÖ OK - Todas as variantes ativas t√™m stats inicializados';
    ELSE
        RAISE WARNING '‚ö†Ô∏è AVISO - % variantes ativas sem stats', missing_count;
    END IF;
END $$;

\echo ''
\echo '‚úÖ Parte 5 conclu√≠da'
\echo ''

-- ==================================================================================
-- PARTE 6: VERIFICAR PERMISSIONS E RLS
-- ==================================================================================

\echo 'üìã PARTE 6: Verificando permissions e RLS...'
\echo ''

-- 6.1 Verificar RLS habilitado
\echo '6.1 Row Level Security (RLS):'
SELECT
    tablename as "Tabela",
    CASE
        WHEN rowsecurity THEN '‚úÖ Habilitado'
        ELSE '‚ùå Desabilitado'
    END as "RLS Status"
FROM pg_tables
WHERE schemaname = 'public'
  AND tablename IN ('variant_stats', 'events', 'assignments', 'experiments', 'variants')
ORDER BY tablename;

\echo ''

-- 6.2 Verificar pol√≠ticas RLS
\echo '6.2 Pol√≠ticas RLS:'
SELECT
    tablename as "Tabela",
    policyname as "Pol√≠tica",
    '‚úÖ' as "Status",
    cmd as "Comando"
FROM pg_policies
WHERE schemaname = 'public'
  AND tablename IN ('variant_stats', 'events', 'assignments')
ORDER BY tablename, policyname;

\echo ''
\echo '‚úÖ Parte 6 conclu√≠da'
\echo ''

-- ==================================================================================
-- PARTE 7: TESTAR FUN√á√ïES RPC
-- ==================================================================================

\echo 'üìã PARTE 7: Testando fun√ß√µes RPC...'
\echo ''

-- 7.1 Criar dados de teste tempor√°rios
DO $$
DECLARE
    test_exp_id UUID;
    test_var_id UUID;
    test_visitor TEXT := 'test_visitor_' || extract(epoch from now())::text;
BEGIN
    -- Verificar se j√° existe experimento de teste
    SELECT id INTO test_exp_id FROM experiments WHERE name = '__TEST_VERIFICATION__' LIMIT 1;

    IF test_exp_id IS NULL THEN
        RAISE NOTICE '‚ö†Ô∏è Nenhum experimento de teste encontrado. Pulando testes de RPC.';
        RAISE NOTICE '‚ÑπÔ∏è As fun√ß√µes RPC ser√£o testadas automaticamente quando voc√™ criar um experimento real.';
    ELSE
        -- Buscar primeira variante do experimento
        SELECT id INTO test_var_id FROM variants WHERE experiment_id = test_exp_id LIMIT 1;

        IF test_var_id IS NOT NULL THEN
            RAISE NOTICE 'üß™ Testando increment_variant_visitors...';
            PERFORM increment_variant_visitors(test_var_id, test_exp_id);
            RAISE NOTICE '‚úÖ increment_variant_visitors funcionou';

            RAISE NOTICE 'üß™ Testando increment_variant_conversions...';
            PERFORM increment_variant_conversions(test_var_id, test_exp_id, 50.00);
            RAISE NOTICE '‚úÖ increment_variant_conversions funcionou';

            RAISE NOTICE 'üß™ Testando get_experiment_stats...';
            PERFORM get_experiment_stats(test_exp_id);
            RAISE NOTICE '‚úÖ get_experiment_stats funcionou';
        END IF;
    END IF;
END $$;

\echo ''
\echo '‚úÖ Parte 7 conclu√≠da'
\echo ''

-- ==================================================================================
-- PARTE 8: RESUMO E STATUS GERAL
-- ==================================================================================

\echo 'üìã PARTE 8: Resumo e Status Geral...'
\echo ''

DO $$
DECLARE
    variant_stats_ok BOOLEAN;
    experiments_ok BOOLEAN;
    assignments_ok BOOLEAN;
    funcoes_rpc_ok BOOLEAN;
    triggers_ok BOOLEAN;
    rls_ok BOOLEAN;
    status_geral TEXT;
BEGIN
    -- Verificar tabelas
    variant_stats_ok := (
        SELECT COUNT(*) FROM information_schema.columns
        WHERE table_name = 'variant_stats'
        AND column_name IN ('visitors', 'conversions', 'revenue', 'last_updated')
    ) = 4;

    experiments_ok := (
        SELECT COUNT(*) FROM information_schema.columns
        WHERE table_name = 'experiments'
        AND column_name IN ('algorithm', 'conversion_url', 'conversion_type')
    ) = 3;

    assignments_ok := (
        SELECT EXISTS (
            SELECT 1 FROM information_schema.tables
            WHERE table_name = 'assignments'
        )
    );

    -- Verificar fun√ß√µes
    funcoes_rpc_ok := (
        SELECT COUNT(*) FROM pg_proc
        WHERE proname IN (
            'increment_variant_visitors',
            'increment_variant_conversions',
            'get_experiment_stats',
            'get_daily_conversions',
            'calculate_significance'
        )
    ) = 5;

    -- Verificar triggers
    triggers_ok := (
        SELECT COUNT(*) FROM pg_trigger
        WHERE tgname = 'trigger_init_variant_stats'
    ) >= 1;

    -- Verificar RLS
    rls_ok := (
        SELECT COUNT(*) FROM pg_tables
        WHERE tablename IN ('variant_stats', 'events', 'assignments')
        AND rowsecurity = true
    ) = 3;

    -- Determinar status geral
    IF variant_stats_ok AND experiments_ok AND assignments_ok AND funcoes_rpc_ok AND triggers_ok AND rls_ok THEN
        status_geral := 'üéâ SISTEMA 100% FUNCIONAL - TUDO OK!';
    ELSIF variant_stats_ok AND funcoes_rpc_ok THEN
        status_geral := '‚úÖ SISTEMA FUNCIONAL - Pequenos ajustes opcionais';
    ELSE
        status_geral := '‚ö†Ô∏è SISTEMA COM PROBLEMAS - Revise os erros acima';
    END IF;

    -- Mostrar resultados
    RAISE NOTICE '';
    RAISE NOTICE '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó';
    RAISE NOTICE '‚ïë  RESULTADO DA VERIFICA√á√ÉO COMPLETA     ‚ïë';
    RAISE NOTICE '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù';
    RAISE NOTICE '';

    RAISE NOTICE 'üìä Tabelas: %',
        CASE WHEN variant_stats_ok AND experiments_ok AND assignments_ok
        THEN '‚úÖ OK' ELSE '‚ùå ERRO' END;

    RAISE NOTICE '‚öôÔ∏è  Fun√ß√µes RPC: %',
        CASE WHEN funcoes_rpc_ok THEN '‚úÖ OK (5/5)' ELSE '‚ùå ERRO' END;

    RAISE NOTICE 'üîÑ Triggers: %',
        CASE WHEN triggers_ok THEN '‚úÖ OK' ELSE '‚ùå ERRO' END;

    RAISE NOTICE 'üîí RLS (Seguran√ßa): %',
        CASE WHEN rls_ok THEN '‚úÖ OK' ELSE '‚ùå ERRO' END;

    RAISE NOTICE '';
    RAISE NOTICE 'STATUS GERAL: %', status_geral;
    RAISE NOTICE '';
END $$;

\echo ''
\echo '=========================================='
\echo ''

-- ==================================================================================
-- PARTE 9: PR√ìXIMOS PASSOS
-- ==================================================================================

\echo 'üìã PR√ìXIMOS PASSOS:'
\echo ''
\echo '1. ‚úÖ Se STATUS GERAL = 100% FUNCIONAL:'
\echo '   ‚Üí Teste criando um experimento no dashboard'
\echo '   ‚Üí Verifique se as m√©tricas atualizam corretamente'
\echo ''
\echo '2. ‚ö†Ô∏è Se STATUS GERAL = COM PROBLEMAS:'
\echo '   ‚Üí Revise os erros marcados com ‚ùå acima'
\echo '   ‚Üí Execute novamente o FIX_COMPLETE_SYSTEM.sql'
\echo '   ‚Üí Execute esta verifica√ß√£o novamente'
\echo ''
\echo '3. üß™ Para testar o sistema completo:'
\echo '   ‚Üí Crie um experimento de teste'
\echo '   ‚Üí Gere o c√≥digo com o Code Generator'
\echo '   ‚Üí Teste em uma p√°gina HTML'
\echo '   ‚Üí Verifique os n√∫meros no dashboard'
\echo ''
\echo '=========================================='
\echo 'üèÅ VERIFICA√á√ÉO COMPLETA FINALIZADA'
\echo '=========================================='
\echo ''
